@page "/prediction"
@inject PredictionViewModel ViewModel
@inject PredictionService PredictionService

<PageTitle>Prediction IA</PageTitle>

<h3>Prédiction IA</h3>

<div>
    <h4>Prédiction avec k-NN :</h4>
    <button @onclick="FetchPredictKnn">Obtenir la prédiction k-NN</button>
</div>

<div style="margin-top: 20px;">
    <h4>Prédiction avec horizon personnalisé :</h4>
    <label for="horizon">Horizon de prédiction (en secondes) :</label>
    <input id="horizon" type="number" @bind="ViewModel.Horizon" min="1" style="margin-right: 10px;" />
    <button @onclick="FetchPredictionWithHorizon">Obtenir la prédiction</button>
</div>

@if (ViewModel.IsLoading)
{
    <p>Chargement...</p>
}
else if (ViewModel.PredictionData != null)
{
    <div style="margin-top: 20px;">
        <h4>Résultat de la prédiction :</h4>
        @if (ViewModel.PredictionData.ContainsKey("prediction"))
        {
            // Désérialisation des données JSON en List<List<decimal>>
            var predictionList = ViewModel.PredictionData["prediction"] as JsonElement?;
            if (predictionList.HasValue)
            {
                var array = predictionList.Value.EnumerateArray().FirstOrDefault();
                var firstPrediction = array[0].GetDecimal();
                <p>Dernière valeur prédite : @firstPrediction seconde</p>
            }
            else
            {
                <p>Aucune prédiction disponible.</p>
            }
        }
        else
        {
            <p>Erreur : données de prédiction mal formées</p>
        }
    </div>
}
else if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
{
    <p style="color: red;">@ViewModel.ErrorMessage</p>
}

@code {
    private async Task FetchPredictKnn()
    {
        await ViewModel.FetchPredictKnnAsync();
    }

    private async Task FetchPredictionWithHorizon()
    {
        await ViewModel.FetchPredictionWithHorizonAsync();
    }
}
