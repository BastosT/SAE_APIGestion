@page "/salles"
@using SAE_CLIENTGestion.Models
@using SAE_CLIENTGestion.Models.DTO
@using SAE_CLIENTGestion.ViewModels
<link href="css/salles.css" rel="stylesheet" />
@inject IJSRuntime JS
@inject SallesViewModel ViewModel

<PageTitle>Gestion des Salles</PageTitle>

<div class="container-fluid main-content overflow-auto">
    @if (!string.IsNullOrEmpty(ViewModel.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show custom-alert" role="alert">
            @ViewModel.SuccessMessage
            <button type="button" class="btn-close" @onclick="() => ViewModel.SuccessMessage = null"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show custom-alert" role="alert">
            @ViewModel.ErrorMessage
            <button type="button" class="btn-close" @onclick="() => ViewModel.ErrorMessage = null"></button>
        </div>
    }

    <!-- Section Batiment-->
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Batiments</h3>
            <button class="btn btn-primary" @onclick="() => { currentBatiment = new(); showBatimentModal = true; isNewBatiment = true; }">
                <i class="fas fa-plus"></i> Nouveau Batiment
            </button>
        </div>

        @if (ViewModel.IsLoading)
        {
            <div class="d-flex justify-content-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
            </div>
        }
        else if (!ViewModel.Batiments.Any())
        {
            <div class="alert alert-info">Aucun batiment n'a été créé.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Adresse</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var batiment in ViewModel.Batiments)
                        {
                            <tr>
                                <td>@batiment.Nom</td>
                                <td>@batiment.Adresse</td>
                                <td>
                                    <button class="btn btn-warning btn-sm me-2" @onclick="() => EditBatiment(batiment)">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" @onclick="() => DeleteBatiment(batiment)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <!-- Section Types de Salle -->
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Types de Salle</h3>
            <button class="btn btn-primary" @onclick="() => { currentTypeSalle = new(); showTypeSalleModal = true; isNewTypeSalle = true; }">
                <i class="fas fa-plus"></i> Nouveau Type de Salle
            </button>
        </div>

        @if (ViewModel.IsLoading)
        {
            <div class="d-flex justify-content-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
            </div>
        }
        else if (!ViewModel.TypesSalle.Any())
        {
            <div class="alert alert-info">Aucun type de salle n'a été créé.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var typeSalle in ViewModel.TypesSalle)
                        {
                            <tr>
                                <td>@typeSalle.Nom</td>
                                <td>@typeSalle.Description</td>
                                <td>
                                    <button class="btn btn-warning btn-sm me-2" @onclick="() => EditTypeSalle(typeSalle)">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" @onclick="() => DeleteTypeSalle(typeSalle)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <!-- Section existante pour les Salles -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gestion des Salles</h2>
        <button class="btn btn-primary" @onclick="() => { currentSalleDTO = new(); showModal = true; isNewSalle = true; }">
            <i class="fas fa-plus"></i> Nouvelle Salle
        </button>
    </div>

    @if (ViewModel.IsLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        </div>
    }
    else if (ViewModel.Salles.Count == 0)
    {
        <div class="alert alert-info">Aucune salle n'a été créée.</div>
    }
    else
    {
        <div class="row">
            @foreach (var salle in ViewModel.Salles)
            {
                <div class="col">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">@salle.Nom</h5>
                            <div>
                                <button class="btn btn-warning btn-sm me-2" @onclick="() => EditSalle(salle)">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" @onclick="() => DeleteSalle(salle)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Surface:</strong> @salle.Surface m²<br>
                                <strong>Bâtiment:</strong> @salle.Batiment.Nom<br>
                                <strong>Type:</strong> @salle.TypeSalle.Nom
                            </div>
                            <div class="room-walls-container">
                                @{
                                    const int SCALE = 40;
                                    const int MARGIN = 80;
                                    const int WALL_THICKNESS = 32;

                                    double currentX = MARGIN;
                                    double currentY = MARGIN;
                                    double minX = currentX;
                                    double minY = currentY;
                                    double maxX = currentX;
                                    double maxY = currentY;

                                    foreach (var mur in salle.Murs)
                                    {
                                        switch (mur.Orientation)
                                        {
                                            case Models.Orientation.Nord:
                                                currentX += mur.Longueur * SCALE;
                                                break;
                                            case Models.Orientation.Sud:
                                                currentX -= mur.Longueur * SCALE;
                                                break;
                                            case Models.Orientation.Est:
                                                currentY += mur.Longueur * SCALE;
                                                break;
                                            case Models.Orientation.Ouest:
                                                currentY -= mur.Longueur * SCALE;
                                                break;
                                        }
                                        minX = Math.Min(minX, currentX);
                                        minY = Math.Min(minY, currentY);
                                        maxX = Math.Max(maxX, currentX);
                                        maxY = Math.Max(maxY, currentY);
                                    }

                                    int width = (int)(maxX - minX + 2 * MARGIN);
                                    int height = (int)(maxY - minY + 2 * MARGIN);
                                    int offsetX = (int)(-minX + MARGIN);
                                    int offsetY = (int)(-minY + MARGIN);

                                    width = Math.Max(width, 400);
                                    height = Math.Max(height, 300);

                                    currentX = MARGIN + offsetX;
                                    currentY = MARGIN + offsetY;
                                }

                                <svg viewBox="0 0 @width @height" class="room-svg" style="width: 100%; min-height: 300px;">
                                    <pattern id="grid-@salle.SalleId" width="@SCALE" height="@SCALE" patternUnits="userSpaceOnUse">
                                        <path d="M @SCALE 0 L 0 0 0 @SCALE" fill="none" stroke="#f0f0f0" stroke-width="0.5" />
                                    </pattern>
                                    <rect width="100%" height="100%" fill="url(#grid-@salle.SalleId)" />

                                    @{
                                        currentX = MARGIN + offsetX;
                                        currentY = MARGIN + offsetY;
                                    }

                                    @foreach (var mur in salle.Murs)
                                    {
                                        double previousX = currentX;
                                        double previousY = currentY;
                                        double wallLength = mur.Longueur * SCALE;
                                        double rectX = previousX;
                                        double rectY = previousY;
                                        double rectWidth = 0;
                                        double rectHeight = 0;

                                        switch (mur.Orientation)
                                        {
                                            case Models.Orientation.Nord:
                                                currentX += wallLength;
                                                rectX = previousX;
                                                rectY = previousY - WALL_THICKNESS / 2;
                                                rectWidth = wallLength;
                                                rectHeight = WALL_THICKNESS;
                                                break;
                                            case Models.Orientation.Sud:
                                                currentX -= wallLength;
                                                rectX = currentX;
                                                rectY = currentY - WALL_THICKNESS / 2;
                                                rectWidth = wallLength;
                                                rectHeight = WALL_THICKNESS;
                                                break;
                                            case Models.Orientation.Est:
                                                currentY += wallLength;
                                                rectX = previousX - WALL_THICKNESS / 2;
                                                rectY = previousY;
                                                rectWidth = WALL_THICKNESS;
                                                rectHeight = wallLength;
                                                break;
                                            case Models.Orientation.Ouest:
                                                currentY -= wallLength;
                                                rectX = previousX - WALL_THICKNESS / 2;
                                                rectY = currentY;
                                                rectWidth = WALL_THICKNESS;
                                                rectHeight = wallLength;
                                                break;
                                        }
                                        <rect x="@rectX" y="@rectY"
                                              width="@rectWidth" height="@rectHeight"
                                              fill="#ff00ff"
                                              opacity="1" />

                                        <circle cx="@currentX" cy="@currentY" r="2" fill="#666" />

                                        double labelX = (previousX + currentX) / 2;
                                        double labelY = (previousY + currentY) / 2;
                                        double offset = WALL_THICKNESS + 10;

                                        switch (mur.Orientation)
                                        {
                                            case Models.Orientation.Nord:
                                                labelY -= offset;
                                                break;
                                            case Models.Orientation.Sud:
                                                labelY += offset;
                                                break;
                                            case Models.Orientation.Est:
                                                labelX += offset;
                                                break;
                                            case Models.Orientation.Ouest:
                                                labelX -= offset;
                                                break;
                                        }

                                        @((MarkupString)$"<text x='{labelX}' y='{labelY}' text-anchor='middle' fill='#333' style='font-size: 12px;'>{mur.Nom} ({mur.Longueur}m)</text>")
                                    }

                                    <!-- Barre d'échelle -->
                                    <line x1="@MARGIN" y1="@(height - MARGIN/2)" x2="@(MARGIN + SCALE)" y2="@(height - MARGIN/2)"
                                          stroke="#666" stroke-width="2" />
                                    @((MarkupString)$"<text x='{MARGIN + SCALE / 2}' y='{height - MARGIN / 2 - 5}' text-anchor='middle' fill='#666' style='font-size: 12px;'>1m</text>")
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Modal pour Ajout/Modification de Type de Salle -->
    @if (showTypeSalleModal)
    {
        <div class="modal fade show" style="display: block;" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@(isNewTypeSalle ? "Nouveau Type de Salle" : "Modifier le Type de Salle")</h5>
                        <button type="button" class="btn-close" @onclick="CloseTypeSalleModal"></button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="@currentTypeSalle" OnValidSubmit="HandleTypeSalleSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="mb-3">
                                <label class="form-label">Nom</label>
                                <InputText class="form-control" @bind-Value="currentTypeSalle.Nom" />
                                <ValidationMessage For="@(() => currentTypeSalle.Nom)" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <InputText class="form-control" @bind-Value="currentTypeSalle.Description" />
                                <ValidationMessage For="@(() => currentTypeSalle.Description)" />
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary me-2">Enregistrer</button>
                                <button type="button" class="btn btn-secondary" @onclick="CloseTypeSalleModal">Annuler</button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }

    <!-- Modal pour Ajout/Modification de Batiment -->
@if (showModalModif)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier la Salle</h5>
                    <button type="button" class="btn-close" @onclick="CloseModalModif"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@currentSalle" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        
                        <!-- Informations générales de la salle -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nom</label>
                                <InputText class="form-control" @bind-Value="currentSalle.Nom" />
                                <ValidationMessage For="@(() => currentSalle.Nom)" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Surface (m²)</label>
                                <InputNumber class="form-control" @bind-Value="currentSalle.Surface" />
                                <ValidationMessage For="@(() => currentSalle.Surface)" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Bâtiment</label>
                                <InputSelect class="form-control" @bind-Value="currentSalle.BatimentId">
                                    <option value="">Sélectionner un bâtiment</option>
                                    @foreach (var batiment in ViewModel.Batiments)
                                    {
                                        <option value="@batiment.BatimentId">@batiment.Nom</option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Type de Salle</label>
                                <InputSelect class="form-control" @bind-Value="currentSalle.TypeSalleId">
                                    <option value="">Sélectionner un type de salle</option>
                                    @foreach (var typeSalle in ViewModel.TypesSalle)
                                    {
                                        <option value="@typeSalle.TypeSalleId">@typeSalle.Nom</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>

                        <!-- Éditeur de murs -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Configuration des murs</h5>
                                    <button type="button" class="btn btn-primary btn-sm" @onclick="AddNewWall">
                                        <i class="bi bi-plus"></i> Ajouter un mur
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Visualisation de la salle -->
                                    <div class="col-md-8">
                                        <div class="border rounded p-2">
                                            <svg @ref="svgElement" width="100%" height="400" viewBox="0 0 800 600" @onmousedown="OnSvgMouseDown" @onmousemove="OnSvgMouseMove" @onmouseup="OnSvgMouseUp">
                                                <!-- Grille de fond -->
                                                <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#f0f0f0" stroke-width="0.5" />
                                                </pattern>
                                                <rect width="100%" height="100%" fill="url(#grid)" />

                                                @foreach (var mur in currentSalle.Murs)
                                                {
                                                    var isSelected = mur == selectedWall;
                                                    var color = isSelected ? "#007bff" : "#dee2e6";
                                                    
                                                    <!-- Dessin du mur -->
                                                    <g @onclick="() => SelectWall(mur)" style="cursor: pointer;">
                                                        @{
                                                            var (x, y, width, height) = CalculateWallDimensions(mur);
                                                            <rect 
                                                                x="@x" 
                                                                y="@y" 
                                                                width="@width" 
                                                                height="@height" 
                                                                fill="@color"
                                                                stroke="@(isSelected ? "#0056b3" : "none")"
                                                                stroke-width="2"
                                                            />
                                                            <!-- Points de contrôle pour le redimensionnement -->
                                                   
                                                        }
                                                    </g>
                                                }
                                            </svg>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                Cliquez sur un mur pour le sélectionner. 
                                                Utilisez les points aux extrémités pour redimensionner.
                                            </small>
                                        </div>
                                    </div>

                                    <!-- Propriétés du mur sélectionné -->
                                    <div class="col-md-4">
                                        @if (selectedWall != null)
                                        {
                                            <div class="border rounded p-3">
                                                <h6>Propriétés du mur</h6>
                                                <div class="mb-3">
                                                    <label class="form-label">Nom</label>
                                                    <InputText class="form-control" @bind-Value="selectedWall.Nom" />
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Longueur (m)</label>
                                                    <InputNumber class="form-control" @bind-Value="selectedWall.Longueur" />
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Hauteur (m)</label>
                                                    <InputNumber class="form-control" @bind-Value="selectedWall.Hauteur" />
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Orientation</label>
                                                    <InputSelect class="form-control" @bind-Value="selectedWall.Orientation">
                                                            @foreach (Models.Orientation orientation in Enum.GetValues(typeof(Models.Orientation)))
                                                        {
                                                            <option value="@orientation">@orientation</option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                                <button type="button" class="btn btn-danger btn-sm" @onclick="() => DeleteWall(selectedWall)">
                                                    <i class="bi bi-trash"></i> Supprimer
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="text-center text-muted p-3">
                                                Sélectionnez un mur pour modifier ses propriétés
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary me-2">Enregistrer</button>
                            <button type="button" class="btn btn-secondary" @onclick="CloseModalModif">Annuler</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

    <!-- Modal de confirmation pour la suppression de Type de Salle -->
    @if (showDeleteTypeSalleConfirmation)
    {
        <div class="modal fade show" style="display: block;" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmer la suppression</h5>
                        <button type="button" class="btn-close" @onclick="() => showDeleteTypeSalleConfirmation = false"></button>
                    </div>
                    <div class="modal-body">
                        <p>Êtes-vous sûr de vouloir supprimer ce type de salle ?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="() => showDeleteTypeSalleConfirmation = false">Annuler</button>
                        <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteTypeSalle">Supprimer</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }

    <!-- Modal pour Ajout de Salle -->
    @if (showModal)
    {
        <div class="modal fade show" style="display: block;" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Nouvelle Salle</h5>
                        <button type="button" class="btn-close" @onclick="CloseModal"></button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="@currentSalle" OnValidSubmit="HandleValidSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary />
                            <div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nom</label>
                                    <InputText class="form-control" @bind-Value="currentSalle.Nom" />
                                    <ValidationMessage For="@(() => currentSalle.Nom)" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Surface (m²)</label>
                                    <InputNumber class="form-control" @bind-Value="currentSalle.Surface" />
                                    <ValidationMessage For="@(() => currentSalle.Surface)" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Bâtiment</label>
                                    <InputSelect class="form-control" @bind-Value="currentSalle.BatimentId">
                                        <option value="">Sélectionner un bâtiment</option>
                                        @foreach (var batiment in ViewModel.Batiments)
                                        {
                                            <option value="@batiment.BatimentId">@batiment.Nom</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => currentSalle.BatimentId)" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Type de Salle</label>
                                    <InputSelect class="form-control" @bind-Value="currentSalle.TypeSalleId">
                                        <option value="">Sélectionner un type de salle</option>
                                        @foreach (var typeSalle in ViewModel.TypesSalle)
                                        {
                                            <option value="@typeSalle.TypeSalleId">@typeSalle.Nom</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => currentSalle.TypeSalleId)" />
                                </div>
                            </div>
                            <div class="card mt-3">
                                <div class="card-header">
                                    Dimensions de la salle (La forme de la salle pourra être modifié)
                                </div>
                                <div class="card-body">
                                    <div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Longueur (m)</label>
                                            <InputNumber class="form-control" @bind-Value="currentDimensions.Longueur" />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Largeur (m)</label>
                                            <InputNumber class="form-control" @bind-Value="currentDimensions.Largeur" />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Hauteur (m)</label>
                                            <InputNumber class="form-control" @bind-Value="currentDimensions.Hauteur" />
                                        </div>
                                    </div>
                                    <small class="text-muted">Lors de la modification il est possible d'ajouter des murs et de modifier leurs dimenssions.'.</small>
                                </div>
                            </div>
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary me-2">Enregistrer</button>
                                <button type="button" class="btn btn-secondary" @onclick="CloseModal">Annuler</button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }

    <!-- Modal pour Modif de Salle -->
    @if (showModalModif)
    {
        <div class="modal fade show" style="display: block;" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modifier la Salle</h5>
                        <button type="button" class="btn-close" @onclick="CloseModalModif"></button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="@currentSalle" OnValidSubmit="HandleValidSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary />
                            <div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nom</label>
                                    <InputText class="form-control" @bind-Value="currentSalle.Nom" />
                                    <ValidationMessage For="@(() => currentSalle.Nom)" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Surface (m²)</label>
                                    <InputNumber class="form-control" @bind-Value="currentSalle.Surface" />
                                    <ValidationMessage For="@(() => currentSalle.Surface)" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Bâtiment</label>
                                    <InputSelect class="form-control" @bind-Value="currentSalle.BatimentId">
                                        <option value="">Sélectionner un bâtiment</option>
                                        @foreach (var batiment in ViewModel.Batiments)
                                        {
                                            <option value="@batiment.BatimentId">@batiment.Nom</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => currentSalle.BatimentId)" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Type de Salle</label>
                                    <InputSelect class="form-control" @bind-Value="currentSalle.TypeSalleId">
                                        <option value="">Sélectionner un type de salle</option>
                                        @foreach (var typeSalle in ViewModel.TypesSalle)
                                        {
                                            <option value="@typeSalle.TypeSalleId">@typeSalle.Nom</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => currentSalle.TypeSalleId)" />
                                </div>
                            </div>
                            <div class="card mt-3">
                                <div class="card-header">
                                    Dimensions de la salle (La forme de la salle pourra être modifié)
                                </div>
                                <div class="card-body">
                                    <div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Longueur (m)</label>
                                            <InputNumber class="form-control" @bind-Value="currentDimensions.Longueur" />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Largeur (m)</label>
                                            <InputNumber class="form-control" @bind-Value="currentDimensions.Largeur" />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Hauteur (m)</label>
                                            <InputNumber class="form-control" @bind-Value="currentDimensions.Hauteur" />
                                        </div>
                                    </div>
                                    <small class="text-muted">Lors de la modification il est possible d'ajouter des murs et de modifier leurs dimenssions.'.</small>
                                </div>
                            </div>
                            <!-- Nouvelle section pour les murs -->
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Modification des murs</h5>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-primary me-2" @onclick="PreviousWall">
                                            <i class="bi bi-arrow-left"></i>
                                        </button>
                                        <span>Mur @(currentWallIndex + 1)/@currentSalle.Murs?.Count</span>
                                        <button type="button" class="btn btn-sm btn-primary ms-2" @onclick="NextWall">
                                            <i class="bi bi-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    @if (currentWall != null)
                                    {
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Nom du mur</label>
                                                    <InputText class="form-control" @bind-Value="currentWall.Nom" />
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Longueur (m)</label>
                                                    <InputNumber class="form-control" @bind-Value="currentWall.Longueur" />
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Hauteur (m)</label>
                                                    <InputNumber class="form-control" @bind-Value="currentWall.Hauteur" />
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Orientation</label>
                                                    <InputSelect class="form-control" @bind-Value="currentWall.Orientation">
                                                        @foreach (Models.Orientation orientation in Enum.GetValues(typeof(Models.Orientation)))
                                                        {
                                                            <option value="@orientation">@orientation</option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <!-- Aperçu en direct -->
                                                <div class="border rounded p-2">
                                                    <svg width="100%" height="200" viewBox="0 0 400 300" class="room-preview">
                                                        <!-- Grille de fond -->
                                                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#f0f0f0" stroke-width="0.5" />
                                                        </pattern>
                                                        <rect width="100%" height="100%" fill="url(#grid)" />

                                                        @{
                                                            double currentX = 200;
                                                            double currentY = 150;
                                                            foreach (var mur in currentSalle.Murs)
                                                            {
                                                                double wallLength = mur.Longueur * 40; // Échelle
                                                                string color = mur == currentWall ? "#007bff" : "#dee2e6";

                                                                <g transform="translate(@currentX @currentY)">
                                                                    @switch (mur.Orientation)
                                                                    {
                                                                        case Models.Orientation.Nord:
                                                                            <line x2="@wallLength" y2="0" stroke="@color" stroke-width="8" />
                                                                            currentX += wallLength;
                                                                            break;
                                                                        case Models.Orientation.Sud:
                                                                            <line x2="-@wallLength" y2="0" stroke="@color" stroke-width="8" />
                                                                            currentX -= wallLength;
                                                                            break;
                                                                        case Models.Orientation.Est:
                                                                            <line x2="0" y2="@wallLength" stroke="@color" stroke-width="8" />
                                                                            currentY += wallLength;
                                                                            break;
                                                                        case Models.Orientation.Ouest:
                                                                            <line x2="0" y2="-@wallLength" stroke="@color" stroke-width="8" />
                                                                            currentY -= wallLength;
                                                                            break;
                                                                    }
                                                                </g>
                                                            }
                                                        }
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary me-2">Enregistrer</button>
                                <button type="button" class="btn btn-secondary" @onclick="CloseModalModif">Annuler</button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }

    <!-- Modal de confirmation pour la suppression -->
    @if (showDeleteConfirmation)
    {
        <div class="modal fade show" style="display: block;" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmer la suppression</h5>
                        <button type="button" class="btn-close" @onclick="() => showDeleteConfirmation = false"></button>
                    </div>
                    <div class="modal-body">
                        <p>Êtes-vous sûr de vouloir supprimer cette salle ?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="() => showDeleteConfirmation = false">Annuler</button>
                        <button type="button" class="btn btn-danger" @onclick="ConfirmDelete">Supprimer</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }

    <!-- Modal pour l'édition/ajout de mur' -->
    @if (showWallModal)
    {
        <div class="modal fade show" style="display: block;" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modifier le Mur</h5>
                        <button type="button" class="btn-close" @onclick="CloseWallModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="accordion" id="wallAccordion">

                            <!-- Gestion des Capteurs -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#capteurs">
                                        Capteurs (@(currentMur.Capteurs?.Count ?? 0))
                                    </button>
                                </h2>
                                <div id="capteurs" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="d-flex justify-content-between mb-3">
                                            <h6>Liste des capteurs</h6>
                                            <button class="btn btn-sm btn-primary" @onclick="() => AddNewCapteur()">
                                                <i class="fas fa-plus"></i> Ajouter un capteur
                                            </button>
                                        </div>

                                        @if (currentMur.Capteurs?.Any() != true)
                                        {
                                            <div class="alert alert-info">Aucun capteur installé sur ce mur.</div>
                                        }
                                        else
                                        {
                                            <div class="list-group">
                                                @foreach (var capteur in currentMur.Capteurs)
                                                {
                                                    <div class="list-group-item">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <h6 class="mb-1">@capteur.Nom</h6>
                                                                <small>Position: X:@capteur.PositionX m, Y:@capteur.PositionY m [Dimensions: @capteur.Longueur x @capteur.Hauteur]</small>
                                                            </div>
                                                            <div>
                                                                <button class="btn btn-sm btn-warning me-2" @onclick="() => EditCapteur(capteur)">
                                                                    <i class="bi bi-pencil"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteCapteur(capteur)">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Gestion des Équipements -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#equipements">
                                        Équipements (@(currentMur.Equipements?.Count ?? 0))
                                    </button>
                                </h2>
                                <div id="equipements" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="d-flex justify-content-between mb-3">
                                            <h6>Liste des équipements</h6>
                                            <button class="btn btn-sm btn-primary" @onclick="() => AddNewEquipement()">
                                                <i class="fas fa-plus"></i> Ajouter un équipement
                                            </button>
                                        </div>

                                        @if (currentMur.Equipements?.Any() != true)
                                        {
                                            <div class="alert alert-info">Aucun équipement installé sur ce mur.</div>
                                        }
                                        else
                                        {
                                            <div class="list-group">
                                                @foreach (var equipement in currentMur.Equipements)
                                                {
                                                    <div class="list-group-item">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <h6 class="mb-1">@equipement.Nom</h6>
                                                                <small>Position: X:@equipement.PositionX m, Y:@equipement.PositionY m  [Dimensions: @equipement.Longueur x @equipement.Hauteur]</small>
                                                                <small>Type équipement: @equipement.TypeEquipement.Nom</small>
                                                            </div>
                                                            <div>
                                                                <button class="btn btn-sm btn-warning me-2" @onclick="() => EditEquipement(equipement)">
                                                                    <i class="bi bi-pencil"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteEquipement(equipement)">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseWallModal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }

    <!-- Modal pour l'édition/ajout de capteur -->
    @if (showCapteurModal)
    {
        <div class="modal fade show" style="display: block;" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@(isNewCapteur ? "Nouveau capteur" : "Modifier le capteur")</h5>
                        <button type="button" class="btn-close" @onclick="CloseCapteurModal"></button>
                    </div>
                    <div class="alert alert-info mb-3">
                        <strong>Dimensions du mur (Mid: @currentMur.MurId Sid: @currentMur.SalleId):</strong>
                        <div>Longueur : @currentMur.Longueur m</div>
                        <div>Hauteur : @currentMur.Hauteur m</div>
                    </div>
                    <!-- Aperçu SVG -->
                    <div style="border: 1px solid #ccc; margin: 0;">
                        <svg width="100%"
                             height="200"
                             viewBox="0 0 @currentMur.Longueur @currentMur.Hauteur"
                             preserveAspectRatio="xMidYMid meet"
                             style="display: block; margin: 0;">
                            <!-- Mur de fond -->
                            <rect x="0" y="0"
                                  width="@currentMur.Longueur"
                                  height="@currentMur.Hauteur"
                                  fill="#f8f9fa"
                                  stroke="#ccc"
                                  stroke-width="1" />

                            <!-- Équipements existants en gris -->
                            @foreach (var equip in currentMur.Capteurs)
                            {
                                <rect x="@equip.PositionX"
                                      y="@equip.PositionY"
                                      width="@equip.Longueur"
                                      height="@equip.Hauteur"
                                      fill="#dee2e6"
                                      stroke="#adb5bd" />
                            }

                            <!-- Nouvel équipement en cours -->
                            @if (currentCapteur.Longueur > 0 && currentCapteur.Hauteur > 0)
                            {
                                <rect x="@currentCapteur.PositionX"
                                      y="@currentCapteur.PositionY"
                                      width="@currentCapteur.Longueur"
                                      height="@currentCapteur.Hauteur"
                                      fill="@(IsCapteurOutOfBounds() ? "#dc3545" : "#007bff")"
                                      fill-opacity="0.5"
                                      stroke="@(IsCapteurOutOfBounds() ? "#dc3545" : "#0056b3")" />
                            }
                        </svg>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            Aperçu du positionnement
                            (@(IsCapteurOutOfBounds() ? "rouge : position invalide" : "bleu : position valide"))
                        </small>
                    </div>
                    <div class="modal-body">
                        @if (IsCapteurOutOfBounds())
                        {
                            <div class="alert alert-danger">
                                Le capteur dépasse les dimensions du mur !
                            </div>
                        }
                        <EditForm Model="@currentCapteur" OnValidSubmit="HandleCapteurSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="mb-3">
                                <label class="form-label">Nom</label>
                                <InputText class="form-control" @bind-Value="currentCapteur.Nom" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Position X (m)</label>
                                <InputNumber class="form-control" @bind-Value="currentCapteur.PositionX" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Position Y (m)</label>
                                <InputNumber class="form-control" @bind-Value="currentCapteur.PositionY" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Longueur</label>
                                <InputNumber class="form-control" @bind-Value="currentCapteur.Longueur" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hauteur</label>
                                <InputNumber class="form-control" @bind-Value="currentCapteur.Hauteur" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Distance de la porte</label>
                                <InputNumber class="form-control" @bind-Value="currentCapteur.DistancePorte" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Distance du/des Chauffage</label>
                                <InputNumber class="form-control" @bind-Value="currentCapteur.DistanceChauffage" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Distance de la/des fenêtre</label>
                                <InputNumber class="form-control" @bind-Value="currentCapteur.DistanceFenetre" />
                            </div>

                            <button type="submit" class="btn btn-primary" disabled="@IsCapteurOutOfBounds()">Enregistrer</button>
                            <button type="button" class="btn btn-secondary" @onclick="CloseCapteurModal">Annuler</button>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }

    <!-- Modal pour l'édition/ajout d'équipement -->
    @if (showEquipementModal)
    {
        <div class="modal fade show" style="display: block;" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@(isNewEquipement ? "Nouvel équipement" : "Modifier l'équipement")</h5>
                        <button type="button" class="btn-close" @onclick="CloseEquipementModal"></button>
                    </div>
                    <div class="alert alert-info mb-3">
                        <strong>Dimensions du mur (Mid: @currentMur.MurId Sid: @currentMur.SalleId):</strong>
                        <div>Longueur : @currentMur.Longueur m</div>
                        <div>Hauteur : @currentMur.Hauteur m</div>
                    </div>

                    <!-- Aperçu SVG -->
                    <div style="border: 1px solid #ccc; margin: 0;">
                        <svg width="100%"
                             height="200"
                             viewBox="0 0 @currentMur.Longueur @currentMur.Hauteur"
                             preserveAspectRatio="xMidYMid meet"
                             style="display: block; margin: 0;">
                            <!-- Mur de fond -->
                            <rect x="0" y="0"
                                  width="@currentMur.Longueur"
                                  height="@currentMur.Hauteur"
                                  fill="#f8f9fa"
                                  stroke="#ccc"
                                  stroke-width="1" />
                            <!-- Équipements existants avec couleurs selon type -->
                            @foreach (var equip in currentMur.Equipements)
                            {
                                string fillColor = GetEquipementColor(equip.TypeEquipementId);
                                string strokeColor = GetEquipementStrokeColor(equip.TypeEquipementId);

                                <rect x="@equip.PositionX"
                                      y="@equip.PositionY"
                                      width="@equip.Longueur"
                                      height="@equip.Hauteur"
                                      fill="@fillColor"
                                      stroke="@strokeColor" />
                            }
                            <!-- Nouvel équipement en cours -->
                            @if (currentEquipement.Longueur > 0 && currentEquipement.Hauteur > 0)
                            {
                                <rect x="@currentEquipement.PositionX"
                                      y="@currentEquipement.PositionY"
                                      width="@currentEquipement.Longueur"
                                      height="@currentEquipement.Hauteur"
                                      fill="@(IsEquipementOutOfBounds() ? "#dc3545" : GetEquipementColor(currentEquipement.TypeEquipementId))"
                                      fill-opacity="0.5"
                                      stroke="@(IsEquipementOutOfBounds() ? "#dc3545" : GetEquipementStrokeColor(currentEquipement.TypeEquipementId))" />
                            }
                        </svg>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            Aperçu du positionnement
                            (@(IsEquipementOutOfBounds() ? "rouge : position invalide" : "bleu : position valide"))
                        </small>
                    </div>

                    <div class="modal-body">
                        @if (IsEquipementOutOfBounds())
                        {
                            <div class="alert alert-danger">
                                L'équipement dépasse les dimensions du mur !
                            </div>
                        }
                        <EditForm Model="@currentEquipement" OnValidSubmit="HandleEquipementSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="mb-3">
                                <label class="form-label">Nom</label>
                                <InputText class="form-control" @bind-Value="currentEquipement.Nom" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Type de Equipement</label>
                                <InputSelect class="form-control" @bind-Value="currentEquipement.TypeEquipementId">
                                    <option value="">Sélectionner un type d'équipement</option>
                                    @foreach (var typeEquipement in ViewModel.TypesEquipement)
                                    {
                                        <option value="@typeEquipement.TypeEquipementId">@typeEquipement.Nom</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => currentSalle.TypeSalleId)" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Position X (m)</label>
                                <InputNumber class="form-control" @bind-Value="currentEquipement.PositionX" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Position Y (m)</label>
                                <InputNumber class="form-control" @bind-Value="currentEquipement.PositionY" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Longueur</label>
                                <InputNumber class="form-control" @bind-Value="currentEquipement.Longueur" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hauteur</label>
                                <InputNumber class="form-control" @bind-Value="currentEquipement.Hauteur" />
                            </div>


                            <button type="submit" class="btn btn-primary" disabled="@IsEquipementOutOfBounds()">Enregistrer</button>
                            <button type="button" class="btn btn-secondary" @onclick="CloseEquipementModal">Annuler</button>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }

</div>



@code {


    private bool showBatimentModal = false;
    private bool showModal = false;
    private bool showModalModif = false;
    private bool showWallModal = false;
    private bool showDeleteConfirmation = false;
    private bool showDeleteBatimentConfirmation = false;
    private bool showCapteurModal = false;
    private bool showEquipementModal = false;
    private bool showTypeSalleModal = false;
    private bool showDeleteTypeSalleConfirmation = false;



    private bool isNewSalle = false;
    private bool isNewBatiment = false;
    private bool isNewCapteur = false;
    private bool isNewEquipement = false;
    private bool isNewTypeSalle = false;


    private Salle currentSalle = new();
    private SalleDTO currentSalleDTO = new();
    private Salle salleToDelete;
    private Mur currentMur;
    private MurCreateParameters murParameters = new();
    private CapteurDTO currentCapteur = new();
    private EquipementDTO currentEquipement = new();
    private TypeSalleDTO currentTypeSalle = new();
    private TypeSalleDTO typeSalleToDelete;
    private SalleDimensions currentDimensions = new();
    private BatimentDTO currentBatiment = new();
    private BatimentDTO batimentToDelete;

    @code {
        private Mur selectedWall;
        private ElementReference svgElement;
        private bool isDragging;
        private string resizingPoint;
        private double startX, startY;

        private void AddNewWall()
        {
            var newWall = new Mur
            {
                Nom = $"Mur {currentSalle.Murs.Count + 1}",
                Longueur = 5,
                Hauteur = 3,
                Orientation = Models.Orientation.Nord
            };

            currentSalle.Murs.Add(newWall);
            SelectWall(newWall);
        }

        private void SelectWall(Mur wall)
        {
            selectedWall = wall;
            StateHasChanged();
        }

        private void DeleteWall(Mur wall)
        {
            currentSalle.Murs.Remove(wall);
            selectedWall = null;
            StateHasChanged();
        }

        private (double x, double y, double width, double height) CalculateWallDimensions(Mur wall)
        {
            const int SCALE = 40; // pixels par mètre
            const int WALL_THICKNESS = 8;

            double x = 400; // Centre de la vue
            double y = 300;
            double width = 0;
            double height = 0;

            switch (wall.Orientation)
            {
                case Models.Orientation.Nord:
                    width = wall.Longueur * SCALE;
                    height = WALL_THICKNESS;
                    break;
                case Models.Orientation.Sud:
                    width = wall.Longueur * SCALE;
                    height = WALL_THICKNESS;
                    y += wall.Longueur * SCALE;
                    break;
                case Models.Orientation.Est:
                    width = WALL_THICKNESS;
                    height = wall.Longueur * SCALE;
                    x += wall.Longueur * SCALE;
                    break;
                case Models.Orientation.Ouest:
                    width = WALL_THICKNESS;
                    height = wall.Longueur * SCALE;
                    break;
            }

            return (x - width / 2, y - height / 2, width, height);
        }

        private void OnSvgMouseDown(MouseEventArgs e)
        {
            if (selectedWall != null)
            {
                isDragging = true;
                startX = e.ClientX;
                startY = e.ClientY;
            }
        }

        private void OnSvgMouseMove(MouseEventArgs e)
        {
            if (isDragging && selectedWall != null)
            {
                var deltaX = e.ClientX - startX;
                var deltaY = e.ClientY - startY;

                // Mettre à jour la position du mur sélectionné
                // Convertir les pixels en mètres
                const double SCALE = 40.0; // pixels par mètre

                if (Math.Abs(deltaX) > SCALE || Math.Abs(deltaY) > SCALE)
                {
                    // Mettre à jour la longueur en fonction de l'orientation
                    if (selectedWall.Orientation == Models.Orientation.Nord || selectedWall.Orientation == Models.Orientation.Sud)
                    {
                        selectedWall.Longueur += deltaX / SCALE;
                    }
                    else
                    {
                        selectedWall.Longueur += deltaY / SCALE;
                    }

                    // S'assurer que la longueur reste positive
                    selectedWall.Longueur = Math.Max(1, selectedWall.Longueur);

                    startX = e.ClientX;
                    startY = e.ClientY;
                    StateHasChanged();
                }
            }
        }

        private void OnSvgMouseUp()
        {
            isDragging = false;
            resizingPoint = null;
        }

        private void StartResizing(MouseEventArgs e, Mur wall, string point)
        {
            selectedWall = wall;
            isDragging = true;
            resizingPoint = point;
            startX = e.ClientX;
            startY = e.ClientY;
        }
    }

    public class MurCreateParameters
    {
        public double Longueur { get; set; }
        public double Largeur { get; set; }
        public double Hauteur { get; set; }
    }

    public class SalleDimensions
    {
        public double Longueur { get; set; } // Longueur des murs gauche/droit
        public double Largeur { get; set; }  // Longueur des murs face/entrée
        public double Hauteur { get; set; }  // Hauteur commune à tous les murs
    }

    private string GetEquipementColor(int typeEquipementId)
    {
        try
        {
            Console.WriteLine($"Debug - TypeEquipementID: {typeEquipementId}");
            Console.WriteLine($"Debug - Nombre de types: {ViewModel.TypesEquipement.Count()}");

            var typeEquipement = ViewModel.TypesEquipement.FirstOrDefault(t => t.TypeEquipementId == typeEquipementId);

            if (typeEquipement != null)
            {
                Console.WriteLine($"Debug - Type trouvé: {typeEquipement.Nom}");

                // Stockons le nom en minuscules pour la comparaison
                var nomType = typeEquipement.Nom.ToLower();
                var couleur = "#dee2e6"; // Couleur par défaut

                return typeEquipement.TypeEquipementId switch
                {
                    1 => "#dee2e6",  // Radiateur - Orange
                    2 => "#2196F3",  // Fenetre - Bleu
                    3 => "#4CE4C1",  // Vitre - Vert
                    4 => "#9C27B0",  // Porte - Violet
                    _ => "#dee2e6"   // Défaut - Gris
                };

                Console.WriteLine($"Debug - Couleur choisie pour {nomType}: {couleur}");
                return couleur;
            }

            Console.WriteLine($"Debug - Aucun type trouvé pour ID: {typeEquipementId}");
            return "#dee2e6";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Debug - Erreur: {ex.Message}");
            return "#dee2e6";
        }
    }

    private int currentWallIndex = 0;
    private Mur currentWall => currentSalle.Murs?.ElementAtOrDefault(currentWallIndex);

    private void NextWall()
    {
        if (currentSalle.Murs != null && currentWallIndex < currentSalle.Murs.Count - 1)
        {
            currentWallIndex++;
            StateHasChanged();
        }
    }

    private void PreviousWall()
    {
        if (currentWallIndex > 0)
        {
            currentWallIndex--;
            StateHasChanged();
        }
    }

    // Modifiez votre méthode EditSalle pour inclure les murs
    private void EditSalle(Salle salle)
    {
        currentSalle = new Salle
            {
                SalleId = salle.SalleId,
                Nom = salle.Nom,
                Surface = salle.Surface,
                TypeSalleId = salle.TypeSalleId,
                BatimentId = salle.BatimentId,
                Murs = salle.Murs?.ToList() ?? new List<Mur>()
            };

        currentWallIndex = 0;
        isNewSalle = false;
        showModalModif = true;
    }

    private string GetEquipementStrokeColor(int typeEquipementId)
    {
        try
        {
            var typeEquipement = ViewModel.TypesEquipement.FirstOrDefault(t => t.TypeEquipementId == typeEquipementId);

            if (typeEquipement != null)
            {
                var nomType = typeEquipement.Nom.ToLower();

                return typeEquipement.TypeEquipementId switch
                {
                    1 => "#E64A19",  // Radiateur - Orange foncé
                    2 => "#1976D2",  // Fenetre - Bleu foncé
                    3 => "#388E3C",  // Vitre - Vert foncé
                    4 => "#7B1FA2",  // Porte - Violet foncé
                    _ => "#adb5bd"   // Défaut - Gris foncé
                };
            }

            return "#adb5bd";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Debug - Erreur dans GetEquipementStrokeColor: {ex.Message}");
            return "#adb5bd";
        }
    }
    protected override async Task OnInitializedAsync()
    {
        await ViewModel.LoadDataAsync();
    }


    private void DeleteSalle(Salle salle)
    {
        salleToDelete = salle;
        showDeleteConfirmation = true;
    }

    private async Task ConfirmDelete()
    {
        if (salleToDelete != null)
        {
            if (await ViewModel.DeleteSalleAsync(salleToDelete.SalleId))
            {
                showDeleteConfirmation = false;
            }
        }
    }

    private void EditWall(Mur mur)
    {
        if (mur != null)
        {
            currentMur = new Mur
                {
                    MurId = mur.MurId,
                    SalleId = mur.SalleId,
                    Nom = mur.Nom,
                    Longueur = mur.Longueur,
                    Hauteur = mur.Hauteur,
                    Orientation = mur.Orientation,
                    Equipements = new List<Equipement>(mur.Equipements ?? new List<Equipement>()),
                    Capteurs = new List<Capteur>(mur.Capteurs ?? new List<Capteur>())
                };
            showWallModal = true;
        }
        else
        {
            currentMur = new Mur
                {
                    Equipements = new List<Equipement>(),
                    Capteurs = new List<Capteur>()
                };
            showWallModal = true;
        }
    }



    private async Task HandleValidSubmit()
    {
        bool success = false;
        try
        {
            if (isNewSalle)
            {
                var createdSalle = await ViewModel.AddSalleAsync(currentSalleDTO);
                if (createdSalle != null)
                {
                    // Créer les murs avec les dimensions spécifiées et l'ID de la salle
                    Mur m1 = await ViewModel.AddMurAsync("M1", Models.Orientation.Nord, currentDimensions.Largeur, currentDimensions.Hauteur, createdSalle.SalleId);
                    Mur m2 = await ViewModel.AddMurAsync("M2", Models.Orientation.Ouest, currentDimensions.Longueur, currentDimensions.Hauteur, createdSalle.SalleId);
                    Mur m3 = await ViewModel.AddMurAsync("M3", Models.Orientation.Sud, currentDimensions.Largeur, currentDimensions.Hauteur, createdSalle.SalleId);
                    Mur m4 = await ViewModel.AddMurAsync("M4", Models.Orientation.Est, currentDimensions.Longueur, currentDimensions.Hauteur, createdSalle.SalleId);
                    success = true;
                }



            }
            else
            {
                // Mettre à jour les dimensions des murs existants
                var salle = await ViewModel.GetSalleByIdAsync(currentSalle.SalleId);


                success = await ViewModel.UpdateSalleAsync(currentSalleDTO);
            }

            if (success)
            {
                await ViewModel.LoadDataAsync();
                ViewModel.SuccessMessage = isNewSalle ? "La salle a été créée avec succès." : "La salle a été modifiée avec succès.";
                showModal = false;
            }
        }
        catch (Exception ex)
        {
            ViewModel.ErrorMessage = "Une erreur est survenue lors de l'opération : " + ex.Message;
        }
    }

    private async Task HandleWallSubmit()
    {
        if (currentMur != null)
        {
            await ViewModel.UpdateMurAsync(currentMur);
            await ViewModel.LoadDataAsync(); // Recharger les données
            showWallModal = false;
        }
    }

    private void AddNewCapteur()
    {
        currentCapteur = new CapteurDTO { MurId = currentMur.MurId };
        isNewCapteur = true;
        showCapteurModal = true;
    }

    private void EditCapteur(Capteur capteur)
    {
        currentCapteur = new CapteurDTO
            {
                CapteurId = capteur.CapteurId,
                Nom = capteur.Nom,
                PositionX = capteur.PositionX,
                PositionY = capteur.PositionY,
                Hauteur = capteur.Hauteur,
                Longueur = capteur.Longueur,
                MurId = capteur.MurId,
                SalleId = capteur.SalleId,
                DistancePorte = capteur.DistancePorte,
                DistanceChauffage = capteur.DistanceChauffage,
                DistanceFenetre = capteur.DistanceFenetre
            };
        isNewCapteur = false;
        showCapteurModal = true;
    }

    private async Task DeleteCapteur(Capteur capteur)
    {
        if (await ViewModel.DeleteCapteurAsync(capteur.CapteurId))
        {
            currentMur.Capteurs.Remove(capteur);
            ViewModel.SuccessMessage = "Le capteur a été supprimé avec succès.";
            StateHasChanged();
        }
    }
    private async Task RefreshMurData()
    {
        try
        {
            // Recharger complètement les données
            await ViewModel.LoadDataAsync();

            // Chercher le mur mis à jour dans les données rechargées


            StateHasChanged();
        }
        catch (Exception ex)
        {
            ViewModel.ErrorMessage = $"Erreur lors du rafraîchissement des données : {ex.Message}";
        }
    }

    private bool IsCapteurOutOfBounds()
    {
        if (currentCapteur == null || currentMur == null) return true;

        return currentCapteur.PositionX < 0 ||
               currentCapteur.PositionY < 0 ||
               (currentCapteur.PositionX + currentCapteur.Longueur) > currentMur.Longueur ||
               (currentCapteur.PositionY + currentCapteur.Hauteur) > currentMur.Hauteur;
    }

    private async Task HandleCapteurSubmit()
    {
        try
        {
            if (isNewCapteur)
            {
                if (await ViewModel.AddCapteurAsync(currentCapteur))
                {
                    // Ajouter le message de succès
                    ViewModel.SuccessMessage = "Le capteur a été ajouté avec succès.";
                    await RefreshMurData();
                    showCapteurModal = false;
                }
            }
            else
            {
                if (await ViewModel.UpdateCapteurAsync(currentCapteur))
                {
                    // Ajouter le message de succès
                    ViewModel.SuccessMessage = "Le capteur a été modifié avec succès.";
                    await RefreshMurData();
                    showCapteurModal = false;
                }
            }
        }
        catch (Exception ex)
        {
            ViewModel.ErrorMessage = $"Erreur lors de la sauvegarde du capteur : {ex.Message}";
        }
    }

    private void AddNewEquipement()
    {

        currentEquipement = new EquipementDTO { MurId = currentMur.MurId };
        isNewEquipement = true;
        showEquipementModal = true;
    }

    private void EditEquipement(Equipement equipement)
    {
        currentEquipement = new EquipementDTO
            {
                EquipementId = equipement.EquipementId,
                Nom = equipement.Nom,
                PositionX = equipement.PositionX,
                PositionY = equipement.PositionY,
                Hauteur = equipement.Hauteur,
                Longueur = equipement.Longueur,
                MurId = equipement.MurId,
                SalleId = equipement.SalleId,
                TypeEquipementId = equipement.TypeEquipementId,
            };

        isNewEquipement = false;
        showEquipementModal = true;
    }

    private async Task DeleteEquipement(Equipement equipement)
    {
        if (await ViewModel.DeleteEquipementAsync(equipement.EquipementId))
        {
            currentMur.Equipements.Remove(equipement);
            ViewModel.SuccessMessage = "L'équipement a été supprimé avec succès.";
            StateHasChanged();
        }
    }

    private bool IsEquipementOutOfBounds()
    {
        if (currentEquipement == null || currentMur == null) return true;

        return currentEquipement.PositionX < 0 ||
               currentEquipement.PositionY < 0 ||
               (currentEquipement.PositionX + currentEquipement.Longueur) > currentMur.Longueur ||
               (currentEquipement.PositionY + currentEquipement.Hauteur) > currentMur.Hauteur;
    }

    private async Task HandleEquipementSubmit()
    {
        try
        {
            if (isNewEquipement)
            {
                if (await ViewModel.AddEquipementAsync(currentEquipement))
                {
                    // Ajouter le message de succès
                    ViewModel.SuccessMessage = "L'équipement a été ajouté avec succès.";
                    await RefreshMurData();
                    showEquipementModal = false;
                }
            }
            else
            {
                if (await ViewModel.UpdateEquipementAsync(currentEquipement))
                {
                    // Ajouter le message de succès
                    ViewModel.SuccessMessage = "L'équipement a été modifié avec succès.";
                    await RefreshMurData();
                    showEquipementModal = false;
                }
            }
        }
        catch (Exception ex)
        {
            ViewModel.ErrorMessage = $"Erreur lors de la sauvegarde de l'équipement : {ex.Message}";
        }
    }

    private void EditBatiment(BatimentDTO batiment)
    {
        currentBatiment = new BatimentDTO
            {
                BatimentId = batiment.BatimentId,
                Nom = batiment.Nom,
                Adresse = batiment.Adresse
            };
        isNewBatiment = false;
        showBatimentModal = true;

    }

    private void DeleteBatiment(BatimentDTO batiment)
    {
        batimentToDelete = batiment;
        showDeleteConfirmation = true;
    }

    private async Task ConfirmDeleteBatiment()
    {
        if (batimentToDelete != null)
        {
            if (await ViewModel.DeleteBatimentAsync(batimentToDelete.BatimentId))
            {
                showDeleteConfirmation = false;
            }
        }
    }

    private async Task HandleValidSubmitBatiment()
    {
        bool success;
        if (isNewBatiment)
        {
            success = await ViewModel.AddBatimentAsync(currentBatiment);
        }
        else
        {
            success = await ViewModel.UpdateBatimentAsync(currentBatiment);
        }

        if (success)
        {
            showModal = false;
        }
    }

    private void CloseBatimentModal()
    {
        showModal = false;
        currentBatiment = new();
        ViewModel.ErrorMessage = null;
        ViewModel.SuccessMessage = null;
    }

    private void EditTypeSalle(TypeSalleDTO typeSalle)
    {
        currentTypeSalle = new TypeSalleDTO
            {
                TypeSalleId = typeSalle.TypeSalleId,
                Nom = typeSalle.Nom,
                Description = typeSalle.Description,
            };
        isNewTypeSalle = false;
        showTypeSalleModal = true;
    }

    private void DeleteTypeSalle(TypeSalleDTO typeSalle)
    {
        typeSalleToDelete = typeSalle;
        showDeleteTypeSalleConfirmation = true;
    }

    private async Task ConfirmDeleteTypeSalle()
    {
        if (typeSalleToDelete != null)
        {
            if (await ViewModel.DeleteTypeSalleAsync(typeSalleToDelete.TypeSalleId))
            {
                showDeleteTypeSalleConfirmation = false;
            }
        }
    }

    private async Task HandleBatimentSubmit()
    {
        bool success;
        if (isNewBatiment)
        {
            success = await ViewModel.AddBatimentAsync(currentBatiment);
        }
        else
        {
            success = await ViewModel.UpdateBatimentAsync(currentBatiment);
            await ViewModel.LoadDataAsync();
        }
        if (success)
        {
            showBatimentModal = false;
        }
    }

    private async Task HandleTypeSalleSubmit()
    {
        bool success;
        if (isNewTypeSalle)
        {
            success = await ViewModel.AddTypeSalleAsync(currentTypeSalle);
        }
        else
        {
            success = await ViewModel.UpdateTypeSalleAsync(currentTypeSalle);
            await ViewModel.LoadDataAsync();
        }
        if (success)
        {
            showTypeSalleModal = false;
        }
    }

    private void CloseTypeSalleModal()
    {
        showTypeSalleModal = false;
        currentTypeSalle = new();
    }

    private void CloseModal()
    {
        showModal = false;
        showWallModal = false;
        currentSalleDTO = new();
    }

    private void CloseModalModif()
    {
        showModalModif = false;
        currentSalle = new();
    }

    private void CloseWallModal()
    {
        showWallModal = false;
        currentMur = null;
    }

    private void CloseCapteurModal()
    {
        showCapteurModal = false;
        currentCapteur = new();
    }

    private void CloseEquipementModal()
    {
        showEquipementModal = false;
        currentEquipement = new();
    }
}